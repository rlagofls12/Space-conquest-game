<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>ğŸš€ ìš°ì£¼ë¥¼ ì •ë³µí•˜ë¼ ğŸŒŒ</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow-x: hidden;
            overscroll-behavior: none;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 20px rgba(138, 43, 226, 0.8); }
            50% { box-shadow: 0 0 40px rgba(138, 43, 226, 1); }
        }
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        * {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        p, span, input {
            -webkit-user-select: text;
            user-select: text;
        }
        html {
            -webkit-overflow-scrolling: touch;
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(138, 43, 226, 0.8);
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: rgba(138, 43, 226, 1);
        }
        .mobile-btn:active {
            transform: scale(0.95);
        }
        @keyframes powerup-appear {
            0% { transform: scale(0) rotate(0deg); opacity: 0; }
            50% { transform: scale(1.2) rotate(180deg); opacity: 1; }
            100% { transform: scale(1) rotate(360deg); opacity: 1; }
        }
        .powerup-item {
            animation: powerup-appear 0.5s ease-out, float 2s ease-in-out infinite;
        }
        @keyframes shield-pulse {
            0%, 100% { transform: scale(1); opacity: 0.6; }
            50% { transform: scale(1.1); opacity: 0.9; }
        }
        .shield-effect {
            animation: shield-pulse 1s ease-in-out infinite;
        }
        .loading-spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        
        /* íˆ´íŒ ìŠ¤íƒ€ì¼ */
        .tooltip-container {
            position: relative;
            display: inline-block;
        }
        
        .tooltip-content {
            visibility: hidden;
            opacity: 0;
            position: absolute;
            bottom: 110%;
            left: 50%;
            transform: translateX(-50%) translateY(5px);
            background: linear-gradient(135deg, rgba(88, 28, 135, 0.98), rgba(67, 56, 202, 0.98));
            color: white;
            padding: 12px 16px;
            border-radius: 12px;
            font-size: 13px;
            white-space: nowrap;
            z-index: 1000;
            border: 2px solid rgba(139, 92, 246, 0.5);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4), 0 0 20px rgba(139, 92, 246, 0.3);
            transition: opacity 0.3s ease, transform 0.3s ease, visibility 0.3s ease;
            pointer-events: none;
            backdrop-filter: blur(10px);
        }
        
        .tooltip-content::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 8px solid transparent;
            border-top-color: rgba(88, 28, 135, 0.98);
        }
        
        .tooltip-container:hover .tooltip-content {
            visibility: visible;
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
        
        .tooltip-title {
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 4px;
            color: #FCD34D;
        }
        
        .tooltip-description {
            color: #E9D5FF;
            font-size: 12px;
            line-height: 1.4;
        }
        
        .tooltip-duration {
            color: #A5F3FC;
            font-size: 11px;
            margin-top: 4px;
            font-weight: 600;
        }
        
        /* í”¼ê²© ë²”ìœ„ í‘œì‹œ */
        @keyframes hitbox-pulse {
            0%, 100% { 
                transform: translate(-50%, -50%) scale(1);
                opacity: 0.3;
            }
            50% { 
                transform: translate(-50%, -50%) scale(1.05);
                opacity: 0.5;
            }
        }
        
        .hitbox-indicator {
            animation: hitbox-pulse 2s ease-in-out infinite;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Firebase ì„¤ì •
        const firebaseConfig = {
          apiKey: "AIzaSyA_GG_oKgw1oDMRv6cEDB3lk7OzhuWpaxs",
          authDomain: "space-conquest-game.firebaseapp.com",
          databaseURL: "https://space-conquest-game-default-rtdb.firebaseio.com",
          projectId: "space-conquest-game",
          storageBucket: "space-conquest-game.firebasestorage.app",
          messagingSenderId: "5243194025",
          appId: "1:5243194025:web:1360c725cbc55f2814f7b8",
          measurementId: "G-J645WHM022"
        };

        // Firebase ì´ˆê¸°í™”
        let database = null;
        let firebaseInitialized = false;

        try {
          if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
          }
          database = firebase.database();
          firebaseInitialized = true;
          console.log('Firebase ì´ˆê¸°í™” ì„±ê³µ!');
        } catch (error) {
          console.error('Firebase ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
          console.log('ë¡œì»¬ ëª¨ë“œë¡œ ì‹¤í–‰ë©ë‹ˆë‹¤.');
        }

        // íˆ´íŒ ì»´í¬ë„ŒíŠ¸
        function PowerupTooltip({ type, children }) {
          const POWERUP_TYPES = {
            SHIELD: { 
              emoji: 'ğŸ›¡ï¸', 
              name: 'ë¸”ë™í™€ ë³´í˜¸ë§‰', 
              duration: 5000, 
              color: 'cyan',
              description: 'ë¸”ë™í™€ì— ë¹¨ë ¤ ë“¤ì–´ê°€ì§€ ì•ŠìŠµë‹ˆë‹¤'
            },
            SLOW: { 
              emoji: 'â°', 
              name: 'ìŠ¬ë¡œìš° ëª¨ì…˜', 
              duration: 4000, 
              color: 'yellow',
              description: 'ëª¨ë“  ì¥ì• ë¬¼ì´ ëŠë ¤ì§‘ë‹ˆë‹¤'
            },
            INVINCIBLE: { 
              emoji: 'â­', 
              name: 'ë¬´ì ', 
              duration: 3000, 
              color: 'gold',
              description: 'ëª¨ë“  ì¥ì• ë¬¼ì„ ë¬´ì‹œí•©ë‹ˆë‹¤'
            },
            DOUBLE_SCORE: { 
              emoji: 'ğŸ”¥', 
              name: 'ë”ë¸” ìŠ¤ì½”ì–´', 
              duration: 5000, 
              color: 'orange',
              description: 'ì ìˆ˜ê°€ 2ë°°ë¡œ ì¦ê°€í•©ë‹ˆë‹¤'
            }
          };

          const powerup = POWERUP_TYPES[type];

          return (
            <div className="tooltip-container">
              {children}
              <div className="tooltip-content">
                <div className="tooltip-title">{powerup.emoji} {powerup.name}</div>
                <div className="tooltip-description">{powerup.description}</div>
                <div className="tooltip-duration">â±ï¸ ì§€ì†ì‹œê°„: {powerup.duration / 1000}ì´ˆ</div>
              </div>
            </div>
          );
        }

        function AsteroidGame() {
          const [gamePhase, setGamePhase] = useState('register');
          const [playerName, setPlayerName] = useState('');
          const [gameState, setGameState] = useState('ready');
          const [score, setScore] = useState(0);
          const [lives, setLives] = useState(3);
          const [shipPosition, setShipPosition] = useState({ x: 50, y: 80 });
          const [asteroids, setAsteroids] = useState([]);
          const [blackHoles, setBlackHoles] = useState([]);
          const [aliens, setAliens] = useState([]);
          const [lasers, setLasers] = useState([]);
          const [planetDebris, setPlanetDebris] = useState([]);
          const [explosions, setExplosions] = useState([]);
          const [powerups, setPowerups] = useState([]);
          const [activePowerup, setActivePowerup] = useState(null);
          const [powerupDuration, setPowerupDuration] = useState(0);
          const [showHitbox, setShowHitbox] = useState(true);
          const [planets, setPlanets] = useState([
            { id: 'left', x: -8, y: 30, health: 100 },
            { id: 'right', x: 108, y: 50, health: 100 }
          ]);
          const [mission, setMission] = useState(1);
          const [missionProgress, setMissionProgress] = useState(0);
          const [totalScore, setTotalScore] = useState(0);
          const [isMobile, setIsMobile] = useState(false);
          const [leaderboard, setLeaderboard] = useState([]);
          const [showScoreboard, setShowScoreboard] = useState(false);
          const [loadingLeaderboard, setLoadingLeaderboard] = useState(true);
          const [playerCountry, setPlayerCountry] = useState('ğŸŒ');
          const gameAreaRef = useRef(null);
          const keysPressed = useRef({});

          const SHIP_SIZE = 24; // 40 * 0.6 = 24 (ë¯¸ë‹ˆ ëª¨ë“œ í¬ê¸°ë¥¼ ê¸°ë³¸ìœ¼ë¡œ)
          const ASTEROID_SIZE = 30;
          const BLACKHOLE_SIZE = 50;
          const ALIEN_SIZE = 40;
          const LASER_SIZE = 20;
          const DEBRIS_SIZE = 35;
          const POWERUP_SIZE = 35;
          const GAME_WIDTH = 400;
          const GAME_HEIGHT = 600;

          const POWERUP_TYPES = {
            SHIELD: { 
              emoji: 'ğŸ›¡ï¸', 
              name: 'ë¸”ë™í™€ ë³´í˜¸ë§‰', 
              duration: 5000, 
              color: 'cyan',
              description: 'ë¸”ë™í™€ì— ë¹¨ë ¤ ë“¤ì–´ê°€ì§€ ì•ŠìŠµë‹ˆë‹¤'
            },
            SLOW: { 
              emoji: 'â°', 
              name: 'ìŠ¬ë¡œìš° ëª¨ì…˜', 
              duration: 4000, 
              color: 'yellow',
              description: 'ëª¨ë“  ì¥ì• ë¬¼ì´ ëŠë ¤ì§‘ë‹ˆë‹¤'
            },
            INVINCIBLE: { 
              emoji: 'â­', 
              name: 'ë¬´ì ', 
              duration: 3000, 
              color: 'gold',
              description: 'ëª¨ë“  ì¥ì• ë¬¼ì„ ë¬´ì‹œí•©ë‹ˆë‹¤'
            },
            DOUBLE_SCORE: { 
              emoji: 'ğŸ”¥', 
              name: 'ë”ë¸” ìŠ¤ì½”ì–´', 
              duration: 5000, 
              color: 'orange',
              description: 'ì ìˆ˜ê°€ 2ë°°ë¡œ ì¦ê°€í•©ë‹ˆë‹¤'
            }
          };

          const missions = [
            { id: 1, name: 'ğŸŒ  ìš´ì„ íšŒí”¼', target: 150, obstacles: ['asteroids'], description: 'ê¸°ë³¸ ìš´ì„ì„ í”¼í•˜ë©° ìƒì¡´í•˜ì„¸ìš”!' },
            { id: 2, name: 'ğŸŒ€ ë¸”ë™í™€ ì§€ëŒ€', target: 250, obstacles: ['asteroids', 'blackHoles'], description: 'ë¸”ë™í™€ì´ ë‚˜íƒ€ë‚¬ìŠµë‹ˆë‹¤!' },
            { id: 3, name: 'ğŸª í–‰ì„± í­ë°œ', target: 350, obstacles: ['asteroids', 'planetDebris'], description: 'ì˜†ì˜ í–‰ì„±ì´ í­ë°œ! íŒŒí¸ì„ í”¼í•˜ì„¸ìš”!' },
            { id: 4, name: 'ğŸ‘½ ì™¸ê³„ì¸ ì¶œí˜„', target: 450, obstacles: ['asteroids', 'aliens', 'lasers'], description: 'ì™¸ê³„ì¸ì˜ ë ˆì´ì € ê³µê²©ì„ í”¼í•˜ì„¸ìš”!' },
            { id: 5, name: 'âš«ë¸”ë™í™€ í­í’', target: 600, obstacles: ['asteroids', 'blackHoles', 'planetDebris'], description: 'ë¸”ë™í™€ê³¼ í–‰ì„± íŒŒí¸ì´ ë™ì‹œì—!' },
            { id: 6, name: 'ğŸ›¸ ì™¸ê³„ í•¨ëŒ€', target: 750, obstacles: ['asteroids', 'aliens', 'lasers', 'blackHoles'], description: 'ì™¸ê³„ í•¨ëŒ€ì˜ ì§‘ì¤‘ ê³µê²©!' },
            { id: 7, name: 'ğŸ’¥ ëŒ€í­ë°œ ì§€ëŒ€', target: 900, obstacles: ['asteroids', 'planetDebris', 'blackHoles', 'aliens'], description: 'ëª¨ë“  ì¥ì• ë¬¼ì´ ë™ì‹œ ì¶œí˜„!' },
            { id: 8, name: 'â˜„ï¸ ì†Œí–‰ì„± ë²¨íŠ¸', target: 1100, obstacles: ['asteroids', 'planetDebris', 'lasers'], description: 'ì—„ì²­ë‚œ ìˆ˜ì˜ ìš´ì„ë“¤!' },
            { id: 9, name: 'ğŸŒŒ ìš°ì£¼ ëŒ€ì¬ì•™', target: 1350, obstacles: ['asteroids', 'blackHoles', 'aliens', 'lasers', 'planetDebris'], description: 'ì§€ì˜¥ ê°™ì€ ìš°ì£¼ ê³µê°„...' },
            { id: 10, name: 'ğŸ‘¾ ìµœì¢… ê²°ì „', target: 1600, obstacles: ['asteroids', 'blackHoles', 'aliens', 'lasers', 'planetDebris'], description: 'ìµœí›„ì˜ ìƒì¡´ ë¯¸ì…˜! ëª¨ë“  ê²ƒì„ í”¼í•˜ì„¸ìš”!' }
          ];

          const currentMission = missions[mission - 1];

          // í”Œë ˆì´ì–´ êµ­ê°€ ê°ì§€ (IP ê¸°ë°˜)
          useEffect(() => {
            fetch('https://ipapi.co/json/')
              .then(res => res.json())
              .then(data => {
                const countryFlags = {
                  'KR': 'ğŸ‡°ğŸ‡·', 'US': 'ğŸ‡ºğŸ‡¸', 'JP': 'ğŸ‡¯ğŸ‡µ', 'CN': 'ğŸ‡¨ğŸ‡³',
                  'GB': 'ğŸ‡¬ğŸ‡§', 'DE': 'ğŸ‡©ğŸ‡ª', 'FR': 'ğŸ‡«ğŸ‡·', 'IT': 'ğŸ‡®ğŸ‡¹',
                  'ES': 'ğŸ‡ªğŸ‡¸', 'CA': 'ğŸ‡¨ğŸ‡¦', 'AU': 'ğŸ‡¦ğŸ‡º', 'BR': 'ğŸ‡§ğŸ‡·',
                  'IN': 'ğŸ‡®ğŸ‡³', 'RU': 'ğŸ‡·ğŸ‡º', 'MX': 'ğŸ‡²ğŸ‡½', 'AR': 'ğŸ‡¦ğŸ‡·'
                };
                setPlayerCountry(countryFlags[data.country_code] || 'ğŸŒ');
              })
              .catch(() => setPlayerCountry('ğŸŒ'));
          }, []);

          // ê¸€ë¡œë²Œ ë¦¬ë”ë³´ë“œ ë¡œë“œ
          useEffect(() => {
            if (!firebaseInitialized) {
              const saved = localStorage.getItem('spaceGameLeaderboard');
              if (saved) {
                setLeaderboard(JSON.parse(saved));
              }
              setLoadingLeaderboard(false);
              return;
            }

            setLoadingLeaderboard(true);
            const leaderboardRef = database.ref('leaderboard');
            
            leaderboardRef.orderByChild('score').limitToLast(100).on('value', (snapshot) => {
              const data = snapshot.val();
              if (data) {
                const leaderboardArray = Object.keys(data).map(key => ({
                  id: key,
                  ...data[key]
                })).sort((a, b) => b.score - a.score);
                setLeaderboard(leaderboardArray);
              }
              setLoadingLeaderboard(false);
            });

            return () => leaderboardRef.off();
          }, []);

          // ê¸€ë¡œë²Œ ë¦¬ë”ë³´ë“œì— ì €ì¥
          const saveToGlobalLeaderboard = (entry) => {
            if (!firebaseInitialized) {
              const updated = [...leaderboard, entry].sort((a, b) => b.score - a.score).slice(0, 50);
              setLeaderboard(updated);
              localStorage.setItem('spaceGameLeaderboard', JSON.stringify(updated));
              return;
            }

            const leaderboardRef = database.ref('leaderboard');
            const newEntryRef = leaderboardRef.push();
            newEntryRef.set({
              name: entry.name,
              score: entry.score,
              mission: entry.mission,
              country: playerCountry,
              date: entry.date,
              timestamp: firebase.database.ServerValue.TIMESTAMP
            }).then(() => {
              console.log('ê¸€ë¡œë²Œ ë¦¬ë”ë³´ë“œì— ì €ì¥ë¨!');
            }).catch((error) => {
              console.error('ì €ì¥ ì‹¤íŒ¨:', error);
            });
          };

          // Detect mobile device
          useEffect(() => {
            const checkMobile = () => {
              setIsMobile(window.innerWidth <= 768 || 'ontouchstart' in window);
            };
            checkMobile();
            window.addEventListener('resize', checkMobile);
            return () => window.removeEventListener('resize', checkMobile);
          }, []);

          const handleRegister = (e) => {
            if (e) e.preventDefault();
            if (playerName.trim().length >= 2) {
              setLives(3);
              setGamePhase('playing');
              setGameState('ready');
            }
          };

          const handleStartClick = () => {
            if (playerName.trim().length >= 2) {
              setLives(3);
              setGamePhase('playing');
              setGameState('ready');
            }
          };

          const handleMobileControl = (direction) => {
            if (gameState !== 'playing') return;
            
            setShipPosition(prev => {
              let newPos = { ...prev };
              const speed = activePowerup === 'SLOW' ? 3 : 5;
              
              if (direction === 'left') {
                newPos.x = Math.max(5, prev.x - speed);
              } else if (direction === 'right') {
                newPos.x = Math.min(95, prev.x + speed);
              } else if (direction === 'up') {
                newPos.y = Math.max(5, prev.y - speed);
              } else if (direction === 'down') {
                newPos.y = Math.min(95, prev.y + speed);
              }
              
              return newPos;
            });
          };

          const handleTouchMove = (e) => {
            if (gameState !== 'playing' || !isMobile) return;
            e.preventDefault();
          };

          const handleTouchStart = (e) => {
            if (gameState !== 'playing' || !isMobile) return;
            e.preventDefault();
            
            const touch = e.touches[0];
            const rect = gameAreaRef.current.getBoundingClientRect();
            
            const touchX = ((touch.clientX - rect.left) / rect.width) * 100;
            const touchY = ((touch.clientY - rect.top) / rect.height) * 100;
            
            setShipPosition(prev => {
              const moveSpeed = 8;
              
              const deltaX = touchX - prev.x;
              const deltaY = touchY - prev.y;
              
              const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
              
              if (distance > 2) {
                const moveX = (deltaX / distance) * moveSpeed;
                const moveY = (deltaY / distance) * moveSpeed;
                
                return {
                  x: Math.max(5, Math.min(95, prev.x + moveX)),
                  y: Math.max(5, Math.min(95, prev.y + moveY))
                };
              }
              
              return prev;
            });
          };

          const handleTouchEnd = () => {};

          // í‚¤ë³´ë“œ ìƒíƒœ ì¶”ì 
          useEffect(() => {
            const handleKeyDown = (e) => {
              if (gameState !== 'playing') return;
              if (['ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown'].includes(e.key)) {
                e.preventDefault();
                keysPressed.current[e.key] = true;
              }
            };

            const handleKeyUp = (e) => {
              if (['ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown'].includes(e.key)) {
                e.preventDefault();
                keysPressed.current[e.key] = false;
              }
            };

            window.addEventListener('keydown', handleKeyDown);
            window.addEventListener('keyup', handleKeyUp);
            return () => {
              window.removeEventListener('keydown', handleKeyDown);
              window.removeEventListener('keyup', handleKeyUp);
            };
          }, [gameState]);

          useEffect(() => {
            if (activePowerup && powerupDuration > 0) {
              const timer = setInterval(() => {
                setPowerupDuration(prev => {
                  if (prev <= 100) {
                    setActivePowerup(null);
                    return 0;
                  }
                  return prev - 100;
                });
              }, 100);
              return () => clearInterval(timer);
            }
          }, [activePowerup, powerupDuration]);

          useEffect(() => {
            if (gameState !== 'playing') return;

            const gameLoop = () => {
              // í‚¤ë³´ë“œ ì…ë ¥ì— ë”°ë¥¸ ìš°ì£¼ì„  ì´ë™
              setShipPosition(prev => {
                let newPos = { ...prev };
                const speed = activePowerup === 'SLOW' ? 0.88 : 1.32;
                
                if (keysPressed.current['ArrowLeft']) {
                  newPos.x = Math.max(5, prev.x - speed);
                }
                if (keysPressed.current['ArrowRight']) {
                  newPos.x = Math.min(95, prev.x + speed);
                }
                if (keysPressed.current['ArrowUp']) {
                  newPos.y = Math.max(5, prev.y - speed);
                }
                if (keysPressed.current['ArrowDown']) {
                  newPos.y = Math.min(95, prev.y + speed);
                }
                
                return newPos;
              });

              const obstacles = currentMission.obstacles;
              const speedMultiplier = activePowerup === 'SLOW' ? 0.5 : 1.0;
              
              const getDifficultyMultiplier = () => {
                if (mission === 8) return 2.5;
                if (mission === 9) return 3.0;
                if (mission === 10) return 3.5;
                if (mission >= 6) return 1.8;
                return 1.0;
              };

              const difficultyMultiplier = getDifficultyMultiplier();
              
              if (Math.random() < 0.008) {
                const availableTypes = [];
                
                if (obstacles.includes('blackHoles')) {
                  availableTypes.push('SHIELD');
                }
                
                availableTypes.push('SLOW');
                availableTypes.push('INVINCIBLE');
                availableTypes.push('DOUBLE_SCORE');
                
                if (availableTypes.length > 0) {
                  const type = availableTypes[Math.floor(Math.random() * availableTypes.length)];
                  setPowerups(prev => [...prev, {
                    id: Date.now() + Math.random(),
                    x: 10 + Math.random() * 80,
                    y: -5,
                    type,
                    speed: 0.5
                  }]);
                }
              }

              setPowerups(prev => prev
                .map(p => ({ ...p, y: p.y + p.speed * speedMultiplier }))
                .filter(p => p.y < 100)
              );

              if (obstacles.includes('asteroids')) {
                setAsteroids(prev => {
                  const updated = prev
                    .map(asteroid => ({ ...asteroid, y: asteroid.y + asteroid.speed * speedMultiplier }))
                    .filter(asteroid => asteroid.y < 100);

                  let spawnRate = mission === 8 ? 0.25 : mission === 9 ? 0.20 : mission === 10 ? 0.18 : 0.06 * difficultyMultiplier;

                  if (Math.random() < spawnRate) {
                    updated.push({
                      id: Date.now() + Math.random(),
                      x: Math.random() * 90,
                      y: -5,
                      speed: 0.8 + Math.random() * (2 + mission * 0.2)
                    });
                  }
                  return updated;
                });
              }

              if (obstacles.includes('blackHoles')) {
                setBlackHoles(prev => {
                  const updated = prev
                    .map(hole => ({ ...hole, y: hole.y + hole.speed * speedMultiplier }))
                    .filter(hole => hole.y < 100);

                  const spawnRate = (mission === 6 || mission === 9 || mission === 10) ? 0.05 : 0.03;

                  if (Math.random() < spawnRate) {
                    updated.push({
                      id: Date.now() + Math.random(),
                      x: Math.random() * 85,
                      y: -5,
                      speed: 0.5 + Math.random() * 1.2
                    });
                  }
                  return updated;
                });
              }

              if (obstacles.includes('planetDebris')) {
                setPlanetDebris(prev => {
                  const updated = prev
                    .map(debris => ({ ...debris, x: debris.x + debris.speedX * speedMultiplier, y: debris.y + debris.speedY * speedMultiplier }))
                    .filter(debris => debris.y < 110 && debris.x > -10 && debris.x < 110);
                  return updated;
                });

                const explosionRate = (mission === 7 || mission === 9) ? 0.025 : 0.015;

                if (Math.random() < explosionRate) {
                  setPlanets(prevPlanets => {
                    const healthyPlanets = prevPlanets.filter(p => p.health > 0);
                    if (healthyPlanets.length === 0) return prevPlanets;
                    
                    const planetToExplode = healthyPlanets[Math.floor(Math.random() * healthyPlanets.length)];
                    
                    setExplosions(exp => [...exp, { id: Date.now(), x: planetToExplode.x, y: planetToExplode.y }]);
                    setTimeout(() => setExplosions(exp => exp.filter(e => e.id !== Date.now())), 1500);

                    const debrisCount = (mission === 7 || mission === 9) ? 15 : mission >= 5 ? 10 : 6;

                    for (let i = 0; i < debrisCount; i++) {
                      const angle = (Math.random() * Math.PI * 0.8) - Math.PI * 0.4;
                      const speed = 1 + Math.random() * 1.5;
                      const directionX = planetToExplode.x < 50 ? 1 : -1;
                      
                      setPlanetDebris(prev => [...prev, {
                        id: Date.now() + Math.random(),
                        x: planetToExplode.x,
                        y: planetToExplode.y,
                        speedX: Math.cos(angle) * speed * directionX,
                        speedY: Math.sin(angle) * speed + 0.3
                      }]);
                    }

                    return prevPlanets.map(p => p.id === planetToExplode.id ? { ...p, health: 0 } : p);
                  });

                  setTimeout(() => setPlanets(prev => prev.map(p => ({ ...p, health: 100 }))), 3000);
                }
              }

              if (obstacles.includes('aliens')) {
                setAliens(prev => {
                  const updated = prev
                    .map(alien => ({ ...alien, y: alien.y + alien.speed * speedMultiplier, x: alien.x + Math.sin(alien.y * 0.1) * 0.5 }))
                    .filter(alien => alien.y < 100);

                  const spawnRate = (mission === 6 || mission === 9 || mission === 10) ? 0.06 : 0.03;

                  if (Math.random() < spawnRate) {
                    updated.push({
                      id: Date.now() + Math.random(),
                      x: Math.random() * 85,
                      y: -5,
                      speed: 0.6 + Math.random() * 1
                    });
                  }
                  return updated;
                });
              }

              if (obstacles.includes('lasers')) {
                setLasers(prev => {
                  const updated = prev
                    .map(laser => ({ ...laser, y: laser.y + laser.speed * speedMultiplier }))
                    .filter(laser => laser.y < 105);

                  const fireRate = (mission === 6 || mission === 8 || mission === 9 || mission === 10) ? 0.08 : 0.04;

                  aliens.forEach(alien => {
                    if (Math.random() < fireRate && alien.y > 10 && alien.y < 70) {
                      updated.push({
                        id: Date.now() + Math.random(),
                        x: alien.x + 2,
                        y: alien.y + 5,
                        speed: 2.5
                      });
                    }
                  });

                  return updated;
                });
              }

              setScore(prev => {
                const scoreIncrement = activePowerup === 'DOUBLE_SCORE' ? 2 : 1;
                const newScore = prev + scoreIncrement;
                setMissionProgress(newScore);
                
                if (newScore >= currentMission.target && mission < missions.length) {
                  setGameState('missionComplete');
                } else if (newScore >= currentMission.target && mission === missions.length) {
                  const finalTotalScore = totalScore + newScore;
                  saveToGlobalLeaderboard({ 
                    name: playerName, 
                    score: finalTotalScore, 
                    mission, 
                    date: new Date().toISOString() 
                  });
                  setTotalScore(finalTotalScore);
                  setGamePhase('gameOver');
                  setGameState('gameOver');
                }
                
                return newScore;
              });
            };

            const interval = setInterval(gameLoop, 50);
            return () => clearInterval(interval);
          }, [gameState, mission, currentMission, aliens, activePowerup, playerName]);

          useEffect(() => {
            if (gameState !== 'playing') return;

            const checkCollision = () => {
              const shipSize = SHIP_SIZE;
              const shipLeft = shipPosition.x;
              const shipRight = shipPosition.x + (shipSize / GAME_WIDTH * 100);
              const shipTop = shipPosition.y;
              const shipBottom = shipPosition.y + (shipSize / GAME_HEIGHT * 100);

              for (let powerup of powerups) {
                const pLeft = powerup.x;
                const pRight = powerup.x + (POWERUP_SIZE / GAME_WIDTH * 100);
                const pTop = powerup.y;
                const pBottom = powerup.y + (POWERUP_SIZE / GAME_HEIGHT * 100);

                if (shipRight > pLeft && shipLeft < pRight && shipBottom > pTop && shipTop < pBottom) {
                  setActivePowerup(powerup.type);
                  setPowerupDuration(POWERUP_TYPES[powerup.type].duration);
                  setPowerups(prev => prev.filter(p => p.id !== powerup.id));
                  return;
                }
              }

              if (activePowerup === 'INVINCIBLE') return;

              const handleDeath = () => {
                setLives(prevLives => {
                  const newLives = prevLives - 1;
                  if (newLives <= 0) {
                    // ëª¨ë“  ëª©ìˆ¨ ì†Œì§„ - ê²Œì„ ì˜¤ë²„
                    const finalTotalScore = totalScore + score;
                    saveToGlobalLeaderboard({ name: playerName, score: finalTotalScore, mission, date: new Date().toISOString() });
                    setTotalScore(finalTotalScore);
                    setGamePhase('gameOver');
                    setGameState('gameOver');
                  } else {
                    // ëª©ìˆ¨ ë‚¨ìŒ - í˜„ì¬ ë¯¸ì…˜ ì¬ì‹œì‘
                    setGameState('lifeLost');
                  }
                  return newLives;
                });
              };

              for (let asteroid of asteroids) {
                const astLeft = asteroid.x;
                const astRight = asteroid.x + (ASTEROID_SIZE / GAME_WIDTH * 100);
                const astTop = asteroid.y;
                const astBottom = asteroid.y + (ASTEROID_SIZE / GAME_HEIGHT * 100);

                if (shipRight > astLeft && shipLeft < astRight && shipBottom > astTop && shipTop < astBottom) {
                  handleDeath();
                  return;
                }
              }

              if (activePowerup !== 'SHIELD') {
                for (let hole of blackHoles) {
                  const holeLeft = hole.x;
                  const holeRight = hole.x + (BLACKHOLE_SIZE / GAME_WIDTH * 100);
                  const holeTop = hole.y;
                  const holeBottom = hole.y + (BLACKHOLE_SIZE / GAME_HEIGHT * 100);

                  if (shipRight > holeLeft && shipLeft < holeRight && shipBottom > holeTop && shipTop < holeBottom) {
                    handleDeath();
                    return;
                  }
                }
              }

              for (let debris of planetDebris) {
                const debrisLeft = debris.x;
                const debrisRight = debris.x + (DEBRIS_SIZE / GAME_WIDTH * 100);
                const debrisTop = debris.y;
                const debrisBottom = debris.y + (DEBRIS_SIZE / GAME_HEIGHT * 100);

                if (shipRight > debrisLeft && shipLeft < debrisRight && shipBottom > debrisTop && shipTop < debrisBottom) {
                  handleDeath();
                  return;
                }
              }

              for (let alien of aliens) {
                const alienLeft = alien.x;
                const alienRight = alien.x + (ALIEN_SIZE / GAME_WIDTH * 100);
                const alienTop = alien.y;
                const alienBottom = alien.y + (ALIEN_SIZE / GAME_HEIGHT * 100);

                if (shipRight > alienLeft && shipLeft < alienRight && shipBottom > alienTop && shipTop < alienBottom) {
                  handleDeath();
                  return;
                }
              }

              for (let laser of lasers) {
                const laserLeft = laser.x;
                const laserRight = laser.x + (LASER_SIZE / GAME_WIDTH * 100);
                const laserTop = laser.y;
                const laserBottom = laser.y + (LASER_SIZE / GAME_HEIGHT * 100);

                if (shipRight > laserLeft && shipLeft < laserRight && shipBottom > laserTop && shipTop < laserBottom) {
                  handleDeath();
                  return;
                }
              }
            };

            checkCollision();
          }, [asteroids, blackHoles, planetDebris, aliens, lasers, powerups, shipPosition, gameState, activePowerup, score, mission, playerName]);

          const startGame = () => {
            setGameState('playing');
            setScore(0);
            setMissionProgress(0);
            setShipPosition({ x: 50, y: 80 });
            setAsteroids([]);
            setBlackHoles([]);
            setAliens([]);
            setLasers([]);
            setPlanetDebris([]);
            setExplosions([]);
            setPowerups([]);
            setActivePowerup(null);
            setPowerupDuration(0);
            setPlanets([
              { id: 'left', x: -8, y: 30, health: 100 },
              { id: 'right', x: 108, y: 50, health: 100 }
            ]);
          };

          const resumeAfterLifeLost = () => {
            setShipPosition({ x: 50, y: 80 });
            setAsteroids([]);
            setBlackHoles([]);
            setAliens([]);
            setLasers([]);
            setPlanetDebris([]);
            setExplosions([]);
            setPowerups([]);
            setActivePowerup(null);
            setPowerupDuration(0);
            setGameState('playing');
          };

          const nextMission = () => {
            setTotalScore(prev => prev + score);
            setMission(prev => prev + 1);
            startGame();
          };

          const restartGame = () => {
            setMission(1);
            setTotalScore(0);
            setLives(3);
            setGamePhase('register');
            setPlayerName('');
            setShowScoreboard(false);
          };

          const continueFromGameOver = () => {
            setMission(1);
            setTotalScore(0);
            setLives(3);
            startGame();
            setGamePhase('playing');
          };

          // Registration Screen
          if (gamePhase === 'register') {
            return (
              <div className="flex items-center justify-center min-h-screen bg-gradient-to-b from-indigo-900 via-purple-900 to-black p-4">
                <div className="text-center max-w-md w-full">
                  <div className="mb-6">
                    <h1 className="text-4xl md:text-5xl font-bold text-white mb-4" style={{
                      textShadow: '0 0 20px rgba(138, 43, 226, 0.8), 0 0 40px rgba(138, 43, 226, 0.5)'
                    }}>
                      ğŸš€ ìš°ì£¼ë¥¼ ì •ë³µí•˜ë¼ ğŸŒŒ
                    </h1>
                    <p className="text-cyan-300 text-sm mb-2">
                      {isMobile ? 'í™”ë©´ì„ íƒ­í•˜ì—¬ ì´ë™í•˜ì„¸ìš”!' : 'ë°©í–¥í‚¤ë¡œ ìš°ì£¼ì„ ì„ ì¡°ì¢…í•˜ì„¸ìš”!'}
                    </p>
                    {firebaseInitialized && (
                      <p className="text-green-400 text-xs font-bold">
                        ğŸŒ ê¸€ë¡œë²Œ ë¦¬ë”ë³´ë“œ í™œì„±í™”!
                      </p>
                    )}
                  </div>

                  <div className="bg-gradient-to-br from-purple-900/80 to-indigo-900/80 backdrop-blur-lg rounded-2xl p-8 border-2 border-purple-500 shadow-2xl">
                    <div className="text-4xl mb-4">ğŸ‘¨â€ğŸš€</div>
                    <h2 className="text-2xl font-bold text-white mb-2">íŒŒì¼ëŸ¿ ë“±ë¡</h2>
                    <p className="text-cyan-300 mb-6">ë‹¹ì‹ ì˜ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”</p>
                    
                    <form onSubmit={handleRegister} className="space-y-4">
                      <input
                        type="text"
                        value={playerName}
                        onChange={(e) => setPlayerName(e.target.value)}
                        placeholder="ì´ë¦„ ì…ë ¥ (ìµœì†Œ 2ê¸€ì)"
                        maxLength={20}
                        className="w-full px-4 py-3 bg-black/50 border-2 border-purple-400 rounded-lg text-white text-center text-xl focus:outline-none focus:border-cyan-400 transition-colors"
                        autoFocus
                      />
                      <button
                        type="submit"
                        onClick={handleStartClick}
                        disabled={playerName.trim().length < 2}
                        className={`w-full px-6 py-4 font-bold rounded-lg text-xl transition-all shadow-lg ${
                          playerName.trim().length >= 2
                            ? 'bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white transform hover:scale-105'
                            : 'bg-gray-600 text-gray-400 cursor-not-allowed'
                        }`}
                      >
                        ğŸš€ ë¯¸ì…˜ ì‹œì‘í•˜ê¸°
                      </button>
                    </form>

                    <button
                      onClick={() => setShowScoreboard(true)}
                      className="mt-4 w-full px-4 py-2 bg-yellow-600/80 hover:bg-yellow-700 text-white font-bold rounded-lg transition-colors"
                    >
                      ğŸ† {firebaseInitialized ? 'ê¸€ë¡œë²Œ' : 'ë¡œì»¬'} ë¦¬ë”ë³´ë“œ ë³´ê¸°
                    </button>
                  </div>

                  <div className="mt-6 text-purple-300 text-sm space-y-2">
                    <p>ğŸ’¡ ë¯¸ì…˜ì— ë”°ë¼ ë‹¤ë¥¸ íŒŒì›Œì—…ì´ ë‚˜íƒ€ë‚©ë‹ˆë‹¤!</p>
                    <p className="text-red-300">â¤ï¸ ëª©ìˆ¨ 3ê°œë¡œ ì „ì²´ ë¯¸ì…˜ì— ë„ì „í•˜ì„¸ìš”!</p>
                    <div className="grid grid-cols-2 gap-2 mt-3">
                      <PowerupTooltip type="SLOW">
                        <div className="bg-black/30 rounded-lg p-2 border border-cyan-400/50 hover:bg-purple-900/40 hover:border-cyan-400 transition-all cursor-help">
                          <span className="text-2xl">â°</span>
                          <p className="text-xs mt-1">ìŠ¬ë¡œìš° ëª¨ì…˜</p>
                          <p className="text-xs text-cyan-300">4ì´ˆ</p>
                        </div>
                      </PowerupTooltip>
                      
                      <PowerupTooltip type="INVINCIBLE">
                        <div className="bg-black/30 rounded-lg p-2 border border-yellow-400/50 hover:bg-purple-900/40 hover:border-yellow-400 transition-all cursor-help">
                          <span className="text-2xl">â­</span>
                          <p className="text-xs mt-1">ë¬´ì </p>
                          <p className="text-xs text-cyan-300">3ì´ˆ</p>
                        </div>
                      </PowerupTooltip>
                      
                      <PowerupTooltip type="DOUBLE_SCORE">
                        <div className="bg-black/30 rounded-lg p-2 border border-orange-400/50 hover:bg-purple-900/40 hover:border-orange-400 transition-all cursor-help">
                          <span className="text-2xl">ğŸ”¥</span>
                          <p className="text-xs mt-1">ë”ë¸” ìŠ¤ì½”ì–´</p>
                          <p className="text-xs text-cyan-300">5ì´ˆ</p>
                        </div>
                      </PowerupTooltip>
                      
                      <PowerupTooltip type="SHIELD">
                        <div className="bg-black/30 rounded-lg p-2 border border-cyan-400/50 hover:bg-purple-900/40 hover:border-cyan-400 transition-all cursor-help">
                          <span className="text-2xl">ğŸ›¡ï¸</span>
                          <p className="text-xs mt-1">ë¸”ë™í™€ ë³´í˜¸ë§‰</p>
                          <p className="text-xs text-orange-300">ë¯¸ì…˜ 2+</p>
                        </div>
                      </PowerupTooltip>
                    </div>
                  </div>
                </div>

                {/* Scoreboard Modal */}
                {showScoreboard && (
                  <div className="fixed inset-0 bg-black/90 flex items-center justify-center z-50 p-4" onClick={() => setShowScoreboard(false)}>
                    <div className="bg-gradient-to-br from-purple-900 to-indigo-900 rounded-2xl p-6 max-w-md w-full max-h-[80vh] overflow-hidden border-2 border-yellow-500" onClick={(e) => e.stopPropagation()}>
                      <h2 className="text-3xl font-bold text-yellow-400 mb-4 text-center">
                        ğŸ† {firebaseInitialized ? 'ê¸€ë¡œë²Œ' : 'ë¡œì»¬'} ë¦¬ë”ë³´ë“œ
                      </h2>
                      {loadingLeaderboard ? (
                        <div className="flex justify-center items-center py-10">
                          <div className="loading-spinner"></div>
                        </div>
                      ) : (
                        <div className="custom-scrollbar overflow-y-auto max-h-[60vh] space-y-2">
                          {leaderboard.length === 0 ? (
                            <p className="text-purple-300 text-center py-8">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</p>
                          ) : (
                            leaderboard.slice(0, 50).map((entry, index) => (
                              <div key={entry.id || index} className={`flex items-center justify-between p-3 rounded-lg ${
                                index === 0 ? 'bg-yellow-600/30 border-2 border-yellow-400' :
                                index === 1 ? 'bg-gray-400/20 border border-gray-400' :
                                index === 2 ? 'bg-orange-600/20 border border-orange-400' :
                                'bg-purple-800/30'
                              }`}>
                                <div className="flex items-center gap-3">
                                  <span className="text-2xl font-bold w-8">
                                    {index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : `${index + 1}.`}
                                  </span>
                                  <div>
                                    <p className="text-white font-bold flex items-center gap-1">
                                      {entry.country || 'ğŸŒ'} {entry.name}
                                    </p>
                                    <p className="text-cyan-300 text-sm">ë¯¸ì…˜ {entry.mission}</p>
                                  </div>
                                </div>
                                <div className="text-right">
                                  <p className="text-yellow-400 font-bold text-lg">{entry.score}</p>
                                  <p className="text-purple-300 text-xs">{new Date(entry.date).toLocaleDateString('ko-KR')}</p>
                                </div>
                              </div>
                            ))
                          )}
                        </div>
                      )}
                      <button
                        onClick={() => setShowScoreboard(false)}
                        className="mt-4 w-full px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-lg transition-colors"
                      >
                        ë‹«ê¸°
                      </button>
                    </div>
                  </div>
                )}
              </div>
            );
          }

          // Game Over Screen
          if (gamePhase === 'gameOver') {
            const playerRank = leaderboard.findIndex(e => e.name === playerName && e.score === totalScore) + 1;
            const isTopScore = playerRank > 0 && playerRank <= 50;

            return (
              <div className="flex items-center justify-center min-h-screen bg-gradient-to-b from-indigo-900 via-purple-900 to-black p-4">
                <div className="text-center max-w-4xl w-full">
                  <div className="mb-6">
                    {score >= currentMission.target && mission === missions.length ? (
                      <div>
                        <div className="text-6xl mb-4 animate-bounce">ğŸ†</div>
                        <h1 className="text-5xl font-bold text-yellow-400 mb-2" style={{
                          textShadow: '0 0 20px rgba(255, 215, 0, 0.8)'
                        }}>
                          ì „ì„¤ì˜ íŒŒì¼ëŸ¿!
                        </h1>
                        <p className="text-2xl text-cyan-300 mb-4">ëª¨ë“  ë¯¸ì…˜ ì™„ë£Œ! ğŸŠ</p>
                      </div>
                    ) : (
                      <div>
                        <div className="text-6xl mb-4">ğŸ’¥</div>
                        <h1 className="text-4xl font-bold text-red-500 mb-2">ë¯¸ì…˜ ì‹¤íŒ¨</h1>
                        <p className="text-xl text-purple-300">ë¯¸ì…˜ {mission}ì—ì„œ ê²©ì¶”ë¨</p>
                        <p className="text-lg text-red-400 mt-2">ëª¨ë“  ëª©ìˆ¨ ì†Œì§„ ğŸ’”ğŸ’”ğŸ’”</p>
                      </div>
                    )}
                  </div>

                  <div className="grid md:grid-cols-2 gap-4 mb-6">
                    {/* Player Score Card */}
                    <div className="bg-gradient-to-br from-purple-900/90 to-indigo-900/90 backdrop-blur-lg rounded-2xl p-6 border-2 border-purple-500">
                      <h3 className="text-2xl font-bold text-white mb-4">ë‹¹ì‹ ì˜ ê¸°ë¡</h3>
                      <div className="space-y-3">
                        <div className="flex justify-between items-center">
                          <span className="text-purple-300">íŒŒì¼ëŸ¿</span>
                          <span className="text-white font-bold text-xl">{playerCountry} {playerName}</span>
                        </div>
                        <div className="flex justify-between items-center">
                          <span className="text-purple-300">ìµœì¢… ì ìˆ˜</span>
                          <span className="text-yellow-400 font-bold text-2xl">{totalScore}</span>
                        </div>
                        <div className="flex justify-between items-center">
                          <span className="text-purple-300">ë„ë‹¬ ë¯¸ì…˜</span>
                          <span className="text-cyan-400 font-bold">ë¯¸ì…˜ {mission}</span>
                        </div>
                        {isTopScore && (
                          <div className="bg-yellow-600/30 rounded-lg p-3 border border-yellow-400 mt-4">
                            <p className="text-yellow-300 font-bold">ğŸ‰ ê¸€ë¡œë²Œ TOP 50 ì§„ì…!</p>
                            <p className="text-white text-sm">ë­í‚¹ #{playerRank}</p>
                          </div>
                        )}
                      </div>
                    </div>

                    {/* Global Top 10 Leaderboard */}
                    <div className="bg-gradient-to-br from-yellow-900/90 to-orange-900/90 backdrop-blur-lg rounded-2xl p-6 border-2 border-yellow-500">
                      <h3 className="text-2xl font-bold text-yellow-400 mb-4">
                        ğŸŒ {firebaseInitialized ? 'ê¸€ë¡œë²Œ' : 'ë¡œì»¬'} TOP 10
                      </h3>
                      {loadingLeaderboard ? (
                        <div className="flex justify-center items-center py-10">
                          <div className="loading-spinner"></div>
                        </div>
                      ) : (
                        <div className="custom-scrollbar overflow-y-auto max-h-64 space-y-2">
                          {leaderboard.slice(0, 10).map((entry, index) => (
                            <div key={entry.id || index} className={`flex items-center justify-between p-2 rounded-lg ${
                              entry.name === playerName && entry.score === totalScore
                                ? 'bg-cyan-600/50 border-2 border-cyan-400'
                                : index === 0 ? 'bg-yellow-600/30' :
                                index === 1 ? 'bg-gray-400/20' :
                                index === 2 ? 'bg-orange-600/20' :
                                'bg-black/20'
                            }`}>
                              <div className="flex items-center gap-2">
                                <span className="text-xl font-bold w-6">
                                  {index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : `${index + 1}`}
                                </span>
                                <div className="text-left">
                                  <p className="text-white font-bold text-sm flex items-center gap-1">
                                    {entry.country || 'ğŸŒ'} {entry.name}
                                  </p>
                                  <p className="text-xs text-purple-300">M{entry.mission}</p>
                                </div>
                              </div>
                              <span className="text-yellow-400 font-bold">{entry.score}</span>
                            </div>
                          ))}
                        </div>
                      )}
                    </div>
                  </div>

                  <div className="flex flex-col sm:flex-row gap-4 justify-center">
                    <button
                      onClick={continueFromGameOver}
                      className="px-8 py-4 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white font-bold rounded-lg text-xl transition-all shadow-lg transform hover:scale-105"
                    >
                      ğŸ”„ ë‹¤ì‹œ ë„ì „
                    </button>
                    <button
                      onClick={restartGame}
                      className="px-8 py-4 bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-700 hover:to-blue-700 text-white font-bold rounded-lg text-xl transition-all shadow-lg transform hover:scale-105"
                    >
                      ğŸ  ë©”ì¸ìœ¼ë¡œ
                    </button>
                  </div>
                </div>
              </div>
            );
          }

          // Main Game Screen
          return (
            <div className={`flex items-center justify-center min-h-screen bg-gradient-to-b from-indigo-900 via-purple-900 to-black ${isMobile ? 'p-2' : 'p-4'}`}>
              <div className="flex flex-col lg:flex-row gap-4 items-start justify-center w-full max-w-7xl">
                <div className="flex-shrink-0">
                  <div className="text-center mb-2">
                    <h1 className={`font-bold text-white mb-2 ${isMobile ? 'text-3xl' : 'text-5xl'}`} style={{
                      textShadow: '0 0 20px rgba(138, 43, 226, 0.8)'
                    }}>
                      ğŸš€ ìš°ì£¼ë¥¼ ì •ë³µí•˜ë¼ ğŸŒŒ
                    </h1>
                    <p className="text-cyan-300 text-sm font-semibold">
                      íŒŒì¼ëŸ¿: <span className="text-yellow-400">{playerCountry} {playerName}</span>
                    </p>
                    <div className="text-yellow-400 font-bold text-lg mt-1">
                      ë¯¸ì…˜ {mission}/10: {currentMission.name}
                    </div>
                  </div>
                  
                  <div 
                    ref={gameAreaRef}
                    className="relative mx-auto bg-black border-4 border-purple-500 rounded-lg overflow-hidden shadow-2xl"
                    style={{ 
                      width: isMobile ? 'min(100vw - 2rem, 400px)' : `${GAME_WIDTH}px`, 
                      height: isMobile ? 'min(150vw - 3rem, 600px)' : `${GAME_HEIGHT}px`,
                      maxWidth: '400px',
                      maxHeight: '600px'
                    }}
                    onTouchStart={handleTouchStart}
                    onTouchMove={handleTouchMove}
                    onTouchEnd={handleTouchEnd}
                  >
                    <div className="absolute inset-0">
                      {[...Array(50)].map((_, i) => (
                        <div
                          key={i}
                          className="absolute w-1 h-1 bg-white rounded-full animate-pulse"
                          style={{
                            left: `${Math.random() * 100}%`,
                            top: `${Math.random() * 100}%`,
                            animationDelay: `${Math.random() * 2}s`
                          }}
                        />
                      ))}
                    </div>

                    {currentMission.obstacles.includes('planetDebris') && planets.map(planet => (
                      planet.health > 0 && (
                        <div
                          key={planet.id}
                          className="absolute text-7xl transition-all duration-500"
                          style={{
                            left: `${planet.x}%`,
                            top: `${planet.y}%`,
                            transform: 'translate(-50%, -50%)',
                            opacity: planet.health / 100,
                            filter: 'drop-shadow(0 0 20px rgba(255, 165, 0, 0.6))'
                          }}
                        >
                          ğŸª
                        </div>
                      )
                    ))}

                    {explosions.map(exp => (
                      <div
                        key={exp.id}
                        className="absolute"
                        style={{
                          left: `${exp.x}%`,
                          top: `${exp.y}%`,
                          transform: 'translate(-50%, -50%)',
                          pointerEvents: 'none'
                        }}
                      >
                        <div className="text-8xl animate-ping">ğŸ’¥</div>
                      </div>
                    ))}

                    {asteroids.map(asteroid => (
                      <div
                        key={asteroid.id}
                        className="absolute text-3xl"
                        style={{
                          left: `${asteroid.x}%`,
                          top: `${asteroid.y}%`,
                          transform: 'translate(-50%, -50%) rotate(45deg)',
                          transition: 'none'
                        }}
                      >
                        â˜„ï¸
                      </div>
                    ))}

                    {blackHoles.map(hole => (
                      <div
                        key={hole.id}
                        className="absolute text-5xl"
                        style={{
                          left: `${hole.x}%`,
                          top: `${hole.y}%`,
                          transform: 'translate(-50%, -50%)',
                          transition: 'none',
                          animation: 'spin 3s linear infinite',
                          opacity: activePowerup === 'SHIELD' ? 0.3 : 1
                        }}
                      >
                        ğŸŒ€
                      </div>
                    ))}

                    {planetDebris.map(debris => (
                      <div
                        key={debris.id}
                        className="absolute text-3xl"
                        style={{
                          left: `${debris.x}%`,
                          top: `${debris.y}%`,
                          transform: 'translate(-50%, -50%) rotate(120deg)',
                          transition: 'none',
                          filter: 'drop-shadow(0 0 5px rgba(255, 100, 0, 0.8))'
                        }}
                      >
                        ğŸª¨
                      </div>
                    ))}

                    {aliens.map(alien => (
                      <div
                        key={alien.id}
                        className="absolute text-3xl"
                        style={{
                          left: `${alien.x}%`,
                          top: `${alien.y}%`,
                          transform: 'translate(-50%, -50%)',
                          transition: 'none'
                        }}
                      >
                        ğŸ‘½
                      </div>
                    ))}

                    {lasers.map(laser => (
                      <div
                        key={laser.id}
                        className="absolute"
                        style={{
                          left: `${laser.x}%`,
                          top: `${laser.y}%`,
                          transform: 'translate(-50%, -50%)',
                          transition: 'none'
                        }}
                      >
                        <div className="w-2 h-6 bg-red-500 shadow-lg shadow-red-500 rounded-full"></div>
                      </div>
                    ))}

                    {powerups.map(powerup => (
                      <div
                        key={powerup.id}
                        className="absolute text-3xl powerup-item"
                        style={{
                          left: `${powerup.x}%`,
                          top: `${powerup.y}%`,
                          transform: 'translate(-50%, -50%)',
                          transition: 'none',
                          filter: `drop-shadow(0 0 10px ${POWERUP_TYPES[powerup.type].color})`
                        }}
                      >
                        {POWERUP_TYPES[powerup.type].emoji}
                      </div>
                    ))}

                    {gameState === 'playing' && (
                      <div
                        className="absolute transition-all duration-100"
                        style={{
                          left: `${shipPosition.x}%`,
                          top: `${shipPosition.y}%`,
                          transform: 'translate(-50%, -50%)',
                          filter: activePowerup === 'INVINCIBLE' 
                            ? 'drop-shadow(0 0 15px gold)' 
                            : activePowerup === 'DOUBLE_SCORE'
                            ? 'drop-shadow(0 0 15px orange)'
                            : 'drop-shadow(0 0 10px rgba(100, 200, 255, 0.8))'
                        }}
                      >
                        <div className="relative">
                          {/* í”¼ê²© ë²”ìœ„ í‘œì‹œ */}
                          {showHitbox && (
                            <div 
                              className="absolute hitbox-indicator rounded-full border-2 border-cyan-400"
                              style={{
                                width: `${SHIP_SIZE}px`,
                                height: `${SHIP_SIZE}px`,
                                left: '50%',
                                top: '50%',
                                transform: 'translate(-50%, -50%)',
                                backgroundColor: 'rgba(0, 255, 255, 0.1)',
                                pointerEvents: 'none'
                              }}
                            />
                          )}
                          
                          <div className={`text-2xl ${activePowerup === 'INVINCIBLE' ? 'animate-pulse' : ''} ${activePowerup === 'DOUBLE_SCORE' ? 'animate-bounce' : ''}`}>
                            ğŸš€
                          </div>
                          {activePowerup === 'SHIELD' && (
                            <div className="absolute inset-0 text-3xl shield-effect" style={{
                              color: 'cyan',
                              transform: 'translate(-50%, -50%)',
                              left: '50%',
                              top: '50%'
                            }}>
                              ğŸ›¡ï¸
                            </div>
                          )}
                        </div>
                      </div>
                    )}

                    {gameState === 'ready' && (
                      <div className="absolute inset-0 flex items-center justify-center bg-black bg-opacity-90">
                        <div className="text-center px-4 max-w-sm">
                          <p className="text-white text-3xl mb-2 font-bold">ğŸŒŸ ë¯¸ì…˜ {mission}</p>
                          <p className="text-yellow-400 text-2xl mb-3">{currentMission.name}</p>
                          <p className="text-purple-300 text-lg mb-4">{currentMission.description}</p>
                          <div className="text-cyan-400 text-sm mb-4 space-y-1">
                            {currentMission.obstacles.includes('asteroids') && <p>â˜„ï¸ ìš´ì„</p>}
                            {currentMission.obstacles.includes('blackHoles') && <p>ğŸŒ€ ë¸”ë™í™€</p>}
                            {currentMission.obstacles.includes('planetDebris') && <p>ğŸª¨ í–‰ì„± íŒŒí¸</p>}
                            {currentMission.obstacles.includes('aliens') && <p>ğŸ‘½ ì™¸ê³„ì¸</p>}
                            {currentMission.obstacles.includes('lasers') && <p>ğŸ”´ ë ˆì´ì €</p>}
                          </div>
                          <button
                            onClick={startGame}
                            className="px-8 py-3 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-lg text-xl transition-colors shadow-lg"
                          >
                            ë¯¸ì…˜ ì‹œì‘
                          </button>
                        </div>
                      </div>
                    )}

                    {gameState === 'lifeLost' && (
                      <div className="absolute inset-0 flex items-center justify-center bg-black bg-opacity-90">
                        <div className="text-center px-4">
                          <div className="text-6xl mb-4">ğŸ’”</div>
                          <p className="text-red-400 text-3xl font-bold mb-2">ëª©ìˆ¨ ì†Œì§„!</p>
                          <p className="text-white text-xl mb-4">ë‚¨ì€ ëª©ìˆ¨: {lives}ê°œ</p>
                          <button
                            onClick={resumeAfterLifeLost}
                            className="px-8 py-3 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg text-xl transition-colors shadow-lg"
                          >
                            ê³„ì†í•˜ê¸°
                          </button>
                        </div>
                      </div>
                    )}

                    {gameState === 'missionComplete' && (
                      <div className="absolute inset-0 flex items-center justify-center bg-black bg-opacity-90">
                        <div className="text-center px-4">
                          <p className="text-green-400 text-4xl font-bold mb-2">ğŸ‰ ë¯¸ì…˜ ì„±ê³µ!</p>
                          <p className="text-white text-2xl mb-2">ë¯¸ì…˜ {mission} í´ë¦¬ì–´!</p>
                          <p className="text-purple-300 mb-4">ì ìˆ˜: {score}</p>
                          {mission < missions.length && (
                            <>
                              <p className="text-yellow-400 text-lg mb-4">ë‹¤ìŒ ë¯¸ì…˜ì€ ë” ì–´ë µìŠµë‹ˆë‹¤...</p>
                              <button
                                onClick={nextMission}
                                className="px-8 py-3 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg text-xl transition-colors shadow-lg"
                              >
                                ë‹¤ìŒ ë¯¸ì…˜
                              </button>
                            </>
                          )}
                        </div>
                      </div>
                    )}

                    {gameState === 'playing' && (
                      <div className="absolute top-4 left-4 right-4">
                        <div className="flex justify-between items-center mb-2">
                          <div className="text-white text-xl font-bold bg-black bg-opacity-80 px-3 py-1 rounded">
                            ì ìˆ˜: {score} {activePowerup === 'DOUBLE_SCORE' && <span className="text-orange-400">Ã—2</span>}
                          </div>
                          <div className="flex items-center gap-2">
                            <div className="text-red-400 text-lg font-bold bg-black bg-opacity-80 px-3 py-1 rounded flex items-center gap-1">
                              {[...Array(lives)].map((_, i) => (
                                <span key={i}>â¤ï¸</span>
                              ))}
                            </div>
                            <div className="text-yellow-400 text-lg font-bold bg-black bg-opacity-80 px-3 py-1 rounded">
                              ë¯¸ì…˜ {mission}/10
                            </div>
                          </div>
                        </div>
                        <div className="bg-gray-700 rounded-full h-3 overflow-hidden border border-purple-400">
                          <div 
                            className="bg-gradient-to-r from-purple-500 via-pink-500 to-yellow-500 h-full transition-all duration-300"
                            style={{ width: `${Math.min((score / currentMission.target) * 100, 100)}%` }}
                          />
                        </div>
                        
                        {activePowerup && (
                          <div className="mt-2 bg-black bg-opacity-80 rounded-lg px-3 py-2 border-2 border-cyan-400">
                            <div className="flex items-center justify-between">
                              <div className="flex items-center gap-2">
                                <span className="text-2xl">{POWERUP_TYPES[activePowerup].emoji}</span>
                                <span className="text-cyan-300 text-sm font-bold">{POWERUP_TYPES[activePowerup].name}</span>
                              </div>
                              <span className="text-yellow-400 text-sm">{(powerupDuration / 1000).toFixed(1)}s</span>
                            </div>
                            <div className="mt-1 bg-gray-700 rounded-full h-1 overflow-hidden">
                              <div 
                                className={`h-full transition-all duration-100 bg-${POWERUP_TYPES[activePowerup].color}-400`}
                                style={{ width: `${(powerupDuration / POWERUP_TYPES[activePowerup].duration) * 100}%` }}
                              />
                            </div>
                          </div>
                        )}
                      </div>
                    )}
                  </div>
                </div>

                {/* Side Scoreboard - Desktop Only */}
                {!isMobile && (
                  <div className="flex-shrink-0 w-80">
                    <div className="bg-gradient-to-br from-purple-900/90 to-indigo-900/90 backdrop-blur-lg rounded-2xl p-4 border-2 border-yellow-500 shadow-2xl sticky top-4">
                      <h2 className="text-2xl font-bold text-yellow-400 mb-3 text-center">
                        ğŸ† {firebaseInitialized ? 'ê¸€ë¡œë²Œ' : 'ë¡œì»¬'} ë¦¬ë”ë³´ë“œ
                      </h2>
                      {loadingLeaderboard ? (
                        <div className="flex justify-center items-center py-10">
                          <div className="loading-spinner"></div>
                        </div>
                      ) : (
                        <div className="custom-scrollbar overflow-y-auto max-h-[500px] space-y-2">
                          {leaderboard.length === 0 ? (
                            <p className="text-purple-300 text-center py-8">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</p>
                          ) : (
                            leaderboard.slice(0, 15).map((entry, index) => (
                              <div key={entry.id || index} className={`flex items-center justify-between p-2 rounded-lg transition-all ${
                                entry.name === playerName ? 'bg-cyan-600/50 border-2 border-cyan-400 scale-105' :
                                index === 0 ? 'bg-yellow-600/30 border border-yellow-400' :
                                index === 1 ? 'bg-gray-400/20 border border-gray-400' :
                                index === 2 ? 'bg-orange-600/20 border border-orange-400' :
                                'bg-purple-800/30 hover:bg-purple-700/30'
                              }`}>
                                <div className="flex items-center gap-2">
                                  <span className="text-xl font-bold w-7">
                                    {index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : `${index + 1}.`}
                                  </span>
                                  <div className="text-left">
                                    <p className={`font-bold text-sm flex items-center gap-1 ${entry.name === playerName ? 'text-cyan-300' : 'text-white'}`}>
                                      {entry.country || 'ğŸŒ'} {entry.name} {entry.name === playerName && 'ğŸ‘ˆ'}
                                    </p>
                                    <p className="text-xs text-purple-300">ë¯¸ì…˜ {entry.mission}</p>
                                  </div>
                                </div>
                                <span className="text-yellow-400 font-bold text-lg">{entry.score}</span>
                              </div>
                            ))
                          )}
                        </div>
                      )}
                      
                      <div className="mt-4 pt-3 border-t-2 border-purple-500">
                        <h3 className="text-lg font-bold text-cyan-300 mb-2">ğŸ’ íŒŒì›Œì—… ê°€ì´ë“œ</h3>
                        <div className="space-y-2">
                          {Object.entries(POWERUP_TYPES).map(([key, value]) => (
                            <PowerupTooltip key={key} type={key}>
                              <div className="flex items-center gap-2 bg-black/30 rounded p-2 cursor-help hover:bg-black/50 transition-colors">
                                <span className="text-2xl">{value.emoji}</span>
                                <div className="flex-1">
                                  <p className="text-white text-xs font-bold">{value.name}</p>
                                  <p className="text-purple-300 text-xs">{value.duration/1000}ì´ˆ</p>
                                </div>
                              </div>
                            </PowerupTooltip>
                          ))}
                        </div>
                      </div>
                    </div>
                  </div>
                )}
              </div>
            </div>
          );
        }

        ReactDOM.render(<AsteroidGame />, document.getElementById('root'));
    </script>
</body>
</html>
